#include "../cub3d.h"

int ft_fill_map(t_map *map, char *argv)
{
    int fd;

    fd = open(argv, O_RDONLY);
    ft_set_textures(map, fd);
    close(fd);
    fd = open(argv, O_RDONLY);
    ft_set_map(map, fd);
    close(fd);
    ft_check_map(map);
    return (0);
}

void ft_check_map(t_map *map)
{
    // int i;

    // i = 0;
    check_walls(map);
    // while (map->c_map[i])
    // {
        
    //     i++;
    // }
    
}

int check_walls(t_map *map)
{
    int i;
    int j;

    i = 0;
    while(map->c_map[0][i])
    {
        if (map->c_map[0][i] == 1)
            i++;
        else if (map->c_map[0][i] == ' ')
        {
            j = 0;
            while (map->c_map[j][i])
            {
                if (map->c_map[j][i] == 1)
                    break;
                else if (map->c_map[j][i] == ' ')
                    j++;
                else
                    return (printf("Map is not surrounded by walls\n"));
            }
        }
        else
            return (printf("Map is not surrounded by walls\n"));
    }
    i = 0;
    while(map->c_map[map->map_len - 1][i])
    {
        if (map->c_map[map->map_len - 1][i] == 1)
            i++;
        else if (map->c_map[map->map_len - 1][i] == ' ')
        {
            j = map->map_len - 1;
            while (map->c_map[j][i])
            {
                if (map->c_map[j][i] == 1)
                    break;
                else if (map->c_map[j][i] == ' ')
                    j--;
                else
                    return (printf("Map is not surrounded by walls\n"));
            }
        }
        else
            return (printf("Map is not surrounded by walls\n"));
    }
    i = 0;
    while(map->c_map[i][0])
    {
        if (map->c_map[i][0] == 1)
            i++;
        else if (map->c_map[i][0] == ' ')
        {
            j = 0;
            while (map->c_map[i][j])
            {
                if (map->c_map[i][j] == 1)
                    break;
                else if (map->c_map[i][j] == ' ')
                    j++;
                else
                    return (printf("Map is not surrounded by walls\n"));
            }
        }
        else
            return (printf("Map is not surrounded by walls\n"));
    }
    return(printf("Map IS surrounded by walls\n"));
}

void ft_set_map(t_map *map, int fd)
{
    char *line;
    int i;

    line = get_next_line(fd);
    i = 0;
    while (line != NULL)
    {
        if (map_start(line) == 1)
        {
            map->map[i] = ft_strdup(line);
            map->c_map[i] = ft_strdup(line);
            i++;
        }
        line = get_next_line(fd);
    }
    i = -1;
    while (map->map[++i])
        printf("%s\n", map->map[i]);
}

void ft_set_textures(t_map *map, int fd)
{
    char *line;

    line = get_next_line(fd);
    while (line != NULL)
    {
        check_texture(line, map);
        if (map_start(line) == 1)
        {
            map->map_len = 1;
            break ;
        }
        line = get_next_line(fd);
    }
    line = get_next_line(fd);
    while (line != NULL && map_start(line) == 1)
    {
        map->map_len++;
        line = get_next_line(fd);
    }
    map->map = malloc(sizeof(char *) * map->map_len + 1);
    map->c_map = malloc(sizeof(char *) * map->map_len + 1);
    if (!map->map || !map->c_map)
        return ;
    printf("map size %d\n", map->map_len);
    printf("textures done\n");
}

int map_start(char *line)
{
    int i;

    i = 0;
    while (line[i] && (line[i] == 32 || (line[i] >= 9 && line[i] <= 13)))
        i++;
    printf("in map start, %d i %c\n", i,  line[i]);
    if (line[i] == 1)
        return (1);
    return(0);
}

void check_texture(char *line, t_map *map)
{
    if (line[0] == 'N' && line[1] == 'O' && line[2] == ' ')
        set_map_val("NO", line, map);
    else if (line[0] == 'S' && line[1] == 'O' && line[2] == ' ')
        set_map_val("SO", line, map);
    else if (line[0] == 'W' && line[1] == 'E' && line[2] == ' ')
        set_map_val("WE", line, map);
    else if (line[0] == 'E' && line[1] == 'A' && line[2] == ' ')
        set_map_val("EA", line, map);
    else if (line[0] == 'R' && line[1] == ' ')
        set_map_val("R", line, map);
    else if (line[0] == 'F' && line[1] == ' ')
        set_map_val("F", line, map);
    else if (line[0] == 'C' && line[1] == ' ')
        set_map_val("C", line, map);
}

void set_map_val(char *str, char *line, t_map *map)
{
    int i;
    int j;
    int size;
    char *s;

    i = 0;
    while (str[i] == line[i])
        i++;
    while (line[i] == ' ' || (line[i] >= 9 && line[i] <= 13))
        i++;
    size = ft_strlen(line) - i + 1;
    s = malloc(sizeof(char) * size);
    if (!s)
        return ;
    j = 0;
    while(line[i])
    {
        s[j] = line[i];
        j++;
        i++;
    }
    s[j] = 0;
    free(line);
    set_map_val2(str, s, map);
}

void set_map_val2(char *str, char *s, t_map *map)
{
    if (str_cmp(str, "NO"))
        map->no = ft_strdup(s);
    else if (str_cmp(str, "SO"))
        map->so = ft_strdup(s);
    else if (str_cmp(str, "WE"))
        map->we = ft_strdup(s);
    else if (str_cmp(str, "EA"))
        map->ea = ft_strdup(s);
    else if (str_cmp(str, "R"))
        set_map_size(s, map);
    else if (str_cmp(str, "F"))
        set_floor_color(s, map);
    else if (str_cmp(str, "C"))
        set_ceiling_color(s, map);
    free(s);
}

void set_ceiling_color(char *s, t_map *map)
{
    int i;
    int j;
    char *color;

    i = -1;
    color = malloc(sizeof(char) * ft_strlen(s));
    j = -1;
    while (s[++i] && (s[i] >= '0' && s[i] <= '9'))
        color[++j] = s[i];
    color[++j] = 0;
    map->c_red = ft_atoi(color);
    while (s[i] && (s[i] == ' ' || (s[i] >= 9 && s[i] <= 13) || s[i] == ','))
        i++;
    j = -1;
    i--;
    while (s[++i] && (s[i] >= '0' && s[i] <= '9'))
        color[++j] = s[i];
    color[++j] = 0;
    map->c_green = ft_atoi(color);
    while (s[i] && (s[i] == ' ' || (s[i] >= 9 && s[i] <= 13) || s[i] == ','))
        i++;
    j = -1;
    i--;
    while (s[++i] && (s[i] >= '0' && s[i] <= '9'))
        color[++j] = s[i];
    color[++j] = 0;
    map->c_blue = ft_atoi(color);
    while (s[i] && (s[i] == ' ' || (s[i] >= 9 && s[i] <= 13) || s[i] == ','))
        i++;
    if (!(map->c_red >= 0 && map->c_red <= 255) || !(map->c_blue >= 0 && map->c_blue <= 255) || !(map->c_green >= 0 && map->c_green <= 255))
    {
        printf("Wrong colors\n");
        return ;
    }
    else
        map->ceiling_color = (map->c_red << 16) + (map->c_green << 8) + map->c_blue;
    printf("Ceiling %ld\n", map->ceiling_color);
}

void set_floor_color(char *s, t_map *map)
{
    int i;
    int j;
    char *color;

    i = -1;
    color = malloc(sizeof(char) * ft_strlen(s));
    j = -1;
    while (s[++i] && (s[i] >= '0' && s[i] <= '9'))
        color[++j] = s[i];
    color[++j] = 0;
    map->f_red = ft_atoi(color);
    while (s[i] && (s[i] == ' ' || (s[i] >= 9 && s[i] <= 13) || s[i] == ','))
        i++;
    j = -1;
    i--;
    while (s[++i] && (s[i] >= '0' && s[i] <= '9'))
        color[++j] = s[i];
    color[++j] = 0;
    map->f_green = ft_atoi(color);
    while (s[i] && (s[i] == ' ' || (s[i] >= 9 && s[i] <= 13) || s[i] == ','))
        i++;
    j = -1;
    i--;
    while (s[++i] && (s[i] >= '0' && s[i] <= '9'))
        color[++j] = s[i];
    color[++j] = 0;
    map->f_blue = ft_atoi(color);
    while (s[i] && (s[i] == ' ' || (s[i] >= 9 && s[i] <= 13) || s[i] == ','))
        i++;
    if (!(map->f_red >= 0 && map->f_red <= 255) || !(map->f_blue >= 0 && map->f_blue <= 255) || !(map->f_green >= 0 && map->f_green <= 255))
    {
        printf("Wrong colors\n");
        return ;
    }
    else
        map->floor_color = (map->f_red << 16) + (map->f_green << 8) + map->f_blue;
     printf("Floor %ld\n", map->floor_color);
}

void set_map_size(char *s, t_map *map) //I DONT NEED IT I GUESS
{
    int i;
    int j;
    char *size;

    i = -1;
    j = -1;
    size = malloc(sizeof(char) * ft_strlen(s) + 1);
    while (s[++i] && (s[i] >= '0' && s[i] <= '9'))
        size[++j] = s[i];
    size[++j] = 0;
    //map->width = ft_atoi(size);
    while (s[i] && (s[i] == ' ' || (s[i] >= 9 && s[i] <= 13)))
        i++;
    //free(size);
    //size = malloc(sizeof(char) * ft_strlen(s) + 1);
    j = -1;
    i--;
    while (s[++i] && (s[i] >= '0' && s[i] <= '9'))
        size[++j] = s[i];
    size[++j] = 0;
    map->height = ft_atoi(size);
    free(size);
}


